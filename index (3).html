<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bhashni Simplified â€” OCR Translator with History</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; }
    body {
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      transition: background 0.4s cubic-bezier(.4,0,.2,1);
    }
    .fade { transition: all 0.3s cubic-bezier(.4,0,.2,1); }
    :focus { outline: 2px solid #2563eb; outline-offset: 2px; }
    .glass {
      background: rgba(255,255,255,0.08);
      box-shadow: 0 4px 32px rgba(0,0,0,0.12);
      backdrop-filter: blur(8px);
    }
    @media (max-width: 640px) {
      .max-w-6xl { max-width: 100vw; }
      .hide-mobile { display: none!important; }
      .translator-row { flex-direction: column !important; }
      .translator-col { width: 100% !important; }
    }
    body.day-mode {
      background: linear-gradient(135deg,#f7fafc 0%,#e2e8f0 100%);
      color: #22223b;
    }
    body.day-mode .glass {
      background: rgba(255,255,255,0.30);
      box-shadow: 0 4px 32px rgba(0,0,0,0.10);
      border-color: #e2e8f0;
    }
    body.day-mode .text-white,
    body.day-mode .font-semibold.text-white { color: #22223b !important; }
    body.day-mode .bg-white\/10 { background-color: rgba(0,0,0,0.02)!important; }
    body.day-mode .bg-blue-900 { background-color: #e2e8f0!important; color: #22223b!important; }
    body.day-mode .shadow-2xl,
    body.day-mode .shadow-xl,
    body.day-mode .shadow-lg { box-shadow: 0 4px 24px rgba(0,0,0,0.08)!important; }
    body.day-mode .border-white\/10,
    body.day-mode .border-white\/5 { border-color: #e2e8f0!important; }
    body.day-mode .rounded-3xl,
    body.day-mode .rounded-2xl,
    body.day-mode .rounded-xl,
    body.day-mode .rounded-lg { border-radius: 1rem!important; }
    body.day-mode .text-blue-300 { color: #2b6cb0!important; }
    body.day-mode .bg-blue-500 { background-color: #2b6cb0!important; }
    body.day-mode .bg-blue-700 { background-color: #2563eb!important; }
    body.day-mode .bg-blue-800 { background-color: #1e40af!important; }
    body.day-mode .bg-blue-200,
    body.day-mode .bg-blue-100 { background-color: #ebf8ff!important; color: #22223b!important; }
    body.day-mode .bg-gray-100 { background-color: #f7fafc!important; color: #22223b!important; }
    body.day-mode .bg-gray-200 { background-color: #e2e8f0!important; color: #22223b!important; }
    body.day-mode .text-gray-400 { color: #4a5568!important; }
    body.day-mode .text-gray-200 { color: #718096!important; }
    body.day-mode .text-gray-300 { color: #a0aec0!important; }
    body.day-mode .text-red-500 { color: #e53e3e!important; }
    body.day-mode .bg-green-500 { background-color: #38a169!important; }
    body.day-mode .bg-green-600 { background-color: #2f855a!important; }
    body.day-mode .bg-red-500 { background-color: #e53e3e!important; }
    body.day-mode .bg-red-600 { background-color: #c53030!important; }
    body.day-mode .border-white\/10 { border-color: #e2e8f0!important; }
    body.day-mode ::placeholder { color: #718096!important; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 text-white">

<main class="glass rounded-3xl shadow-2xl max-w-6xl w-full p-4 md:p-8 space-y-8 grid md:grid-cols-[2fr,1fr] gap-6" aria-label="Translator and History">

  <!-- Translator Panel -->
  <section class="space-y-8 flex flex-col justify-between" aria-label="Translation panel">

    <!-- Header -->
    <header class="flex justify-between items-center pb-2 border-b border-white/10">
      <div class="flex items-center gap-2">
        <img src="https://img.icons8.com/color/48/translation.png" width="36" height="36" alt="Logo" class="rounded-lg shadow-md">
        <h1 class="text-2xl font-semibold tracking-tight text-white" tabindex="0" aria-label="Bhashni Translator">Bhashni Translator</h1>
      </div>
      <div class="flex items-center gap-4">
        <span class="text-xs text-gray-300 hide-mobile" title="Microphone and Camera need HTTPS or localhost">Mic/Camera require HTTPS or localhost</span>
        <button id="darkToggle" class="ml-2 text-lg px-2 py-1 bg-white/10 rounded hover:bg-white/20 shadow-sm" aria-label="Toggle dark mode" title="Toggle dark mode">ðŸŒ™</button>
      </div>
    </header>

    <!-- Source and Target on the same row -->
    <div class="flex translator-row gap-6 w-full">
      <!-- Source column -->
      <div class="translator-col flex-1 flex flex-col">
        <label for="src" class="text-gray-400 text-sm mb-2">Source Text</label>
        <textarea id="src" aria-label="Source text" class="w-full h-44 bg-white/10 text-white rounded-xl p-4 outline-none resize-none border border-white/10 focus:ring-2 focus:ring-blue-400 font-medium placeholder:text-gray-400 mb-2" placeholder="Type, speak, or scan image..." autocomplete="off"></textarea>
        <div class="flex gap-2">
          <button id="speakSrc" class="fade px-3 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 shadow" aria-label="Speak source" title="Listen Source"><span class="material-icons" style="font-size:20px">volume_up</span></button>
          <button id="copySrc" class="fade px-3 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 shadow" aria-label="Copy source" title="Copy Source"><span class="material-icons" style="font-size:20px">content_copy</span></button>
          <select id="langFrom" class="bg-white/10 rounded-lg p-2 text-white border border-white/10 focus:ring-2 focus:ring-blue-400 font-semibold"></select>
        </div>
      </div>
      <!-- Swap Languages Button -->
      <div class="flex flex-col justify-center items-center px-2">
        <button id="swap" class="fade px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-700 shadow font-bold" aria-label="Swap languages" title="Swap Languages">â‡„</button>
      </div>
      <!-- Target column -->
      <div class="translator-col flex-1 flex flex-col">
        <label for="tgt" class="text-gray-400 text-sm mb-2">Translation</label>
        <textarea id="tgt" aria-label="Translation result" class="w-full h-44 bg-white/10 text-white rounded-xl p-4 outline-none resize-none border border-white/10 font-medium placeholder:text-gray-400 mb-2" placeholder="Translation appears here" readonly tabindex="0"></textarea>
        <div class="flex gap-2">
          <select id="langTo" class="bg-white/10 rounded-lg p-2 text-white border border-white/10 focus:ring-2 focus:ring-blue-400 font-semibold"></select>
          <button id="speakTgt" class="fade px-3 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 shadow" aria-label="Speak translation" title="Listen Translation"><span class="material-icons" style="font-size:20px">volume_up</span></button>
          <button id="copyTgt" class="fade px-3 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 shadow" aria-label="Copy translation" title="Copy Translation"><span class="material-icons" style="font-size:20px">content_copy</span></button>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-4">
      <button id="translateBtn" class="flex-1 px-5 py-4 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 rounded-xl font-semibold text-lg shadow-lg hover:scale-105 transition-transform" aria-label="Translate">Translate</button>
      <button id="micBtn" class="px-5 py-4 bg-blue-700 rounded-xl font-semibold text-lg shadow-lg hover:bg-blue-800 transition-colors" aria-label="Microphone"><span class="material-icons" style="font-size:22px;vertical-align:middle">mic</span> <span class="ml-2 hide-mobile">Speak</span></button>
    </div>

    <!-- Camera / OCR Controls -->
    <div class="flex flex-wrap gap-4 items-center mt-1" id="cameraControls" aria-label="Camera controls">
      <button id="uploadBtn" class="px-4 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 shadow" aria-label="Upload image" title="Upload Image"><span class="material-icons" style="font-size:20px">upload</span></button>
      <button id="openCamBtn" class="px-4 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 shadow" aria-label="Open camera" title="Open Camera"><span class="material-icons" style="font-size:20px">photo_camera</span></button>
      <button id="captureBtn" class="px-4 py-3 bg-green-500 text-white rounded-lg font-semibold shadow hover:bg-green-600" disabled aria-label="Capture and OCR" title="Capture & OCR">â§‰ OCR</button>
      <button id="closeCamBtn" class="px-4 py-3 bg-red-500 text-white rounded-lg font-semibold shadow hover:bg-red-600" disabled aria-label="Stop camera" title="Stop Camera"><span class="material-icons" style="font-size:20px">close</span></button>
      <span class="text-sm text-gray-200 ml-2" id="ocrStatus">OCR: idle</span>
      <progress id="ocrProgress" max="1" value="0" class="hidden ml-2 h-1 w-40"></progress>
    </div>

    <!-- Camera preview -->
    <div id="mediaWrap" class="hidden rounded-xl overflow-hidden shadow-lg mt-3">
      <video id="video" playsinline class="w-full max-h-72 bg-black" aria-label="Camera preview"></video>
      <canvas id="canvas" class="hidden"></canvas>
    </div>

  </section>

  <!-- History Panel -->
  <aside class="glass bg-white/10 rounded-2xl p-5 flex flex-col h-full shadow-xl border border-white/10" aria-label="Translation history">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-white flex items-center gap-2"><span class="material-icons" style="font-size:24px;">history</span>History</h2>
      <button id="clearHistory" class="text-sm text-red-500 hover:underline font-semibold" aria-label="Clear history">Clear</button>
    </div>
    <div id="historyList" class="flex-1 overflow-y-auto space-y-3 pr-1 text-sm" tabindex="0"></div>
  </aside>

</main>

<input type="file" id="imgInput" accept="image/*" capture="environment" hidden aria-hidden="true">

<div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-blue-900 text-white px-6 py-3 rounded-xl shadow-lg z-50 hidden font-semibold text-lg" role="status"></div>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<script>
(() => {
  //==== Utility ====
  const $ = id => document.getElementById(id);
  function debounce(fn, ms=400) {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); };
  }

  //==== Elements ====
  const src = $('src'), tgt = $('tgt');
  const langFrom = $('langFrom'), langTo = $('langTo');
  const translateBtn = $('translateBtn'), micBtn = $('micBtn'), swapBtn = $('swap');
  const speakSrc = $('speakSrc'), speakTgt = $('speakTgt');
  const copySrc = $('copySrc'), copyTgt = $('copyTgt');
  const toast = $('toast'), uploadBtn = $('uploadBtn'), openCamBtn = $('openCamBtn');
  const captureBtn = $('captureBtn'), closeCamBtn = $('closeCamBtn'), imgInput = $('imgInput');
  const video = $('video'), canvas = $('canvas'), mediaWrap = $('mediaWrap');
  const ocrProgress = $('ocrProgress'), ocrStatus = $('ocrStatus'), historyList = $('historyList');
  const clearHistoryBtn = $('clearHistory'), darkToggle = $('darkToggle');

  //==== Languages ====
  const LANGS = {
    "auto":"Auto-detect",
    "en":"English","hi":"Hindi","as":"Assamese","bn":"Bengali","mni":"Manipuri","bdo":"Bodo","lus":"Mizo","kha":"Khasi","ne":"Nepali",
    "or":"Odia","pa":"Punjabi","gu":"Gujarati","ta":"Tamil","te":"Telugu","kn":"Kannada","ml":"Malayalam","ur":"Urdu",
    "es":"Spanish","fr":"French","de":"German","it":"Italian","ru":"Russian","zh":"Chinese","ja":"Japanese","ko":"Korean","ar":"Arabic","pt":"Portuguese"
  };
  const TESSERACT_LANG = {en:'eng', hi:'hin', bn:'ben', as:'asm', ne:'nep', pa:'pan', gu:'guj', or:'ori', ta:'tam', te:'tel', kn:'kan', ml:'mal', ur:'urd', ja:'jpn', zh:'chi_sim', ko:'kor', ru:'rus', es:'spa', fr:'fra', de:'deu', it:'ita', ar:'ara', pt:'por'};

  //==== History functions ====
  function getHistory() {
    try { return JSON.parse(localStorage.getItem('translationHistory') || '[]'); }
    catch { return []; }
  }
  function saveHistory(history) {
    try { localStorage.setItem('translationHistory', JSON.stringify(history)); } catch{}
  }
  function addHistory(fromLang, fromText, toLang, toText) {
    if(!fromText || !toText) return;
    let history = getHistory();
    history.unshift({ fromLang, fromText, toLang, toText, time: Date.now() });
    if(history.length > 50) history.pop();
    saveHistory(history);
    renderHistory();
  }
  function renderHistory() {
    historyList.innerHTML = '';
    let history = getHistory();
    if (history.length === 0) {
      historyList.innerHTML = `<div class="text-gray-400 px-2 py-6 text-center">No translations yet.</div>`;
      return;
    }
    history.forEach(item => {
      let div = document.createElement('div');
      div.className = 'p-3 bg-white/10 rounded-xl cursor-pointer hover:bg-blue-600/20 transition-colors shadow-sm border border-white/5';
      div.setAttribute('tabindex', '0');
      div.setAttribute('aria-label', `${LANGS[item.fromLang] || item.fromLang} to ${LANGS[item.toLang] || item.toLang}: ${item.fromText} â†’ ${item.toText}`);
      div.innerHTML = `
        <div class="flex justify-between text-xs text-gray-400 mb-1">
          <span class="font-semibold">${LANGS[item.fromLang] || item.fromLang}</span>
          <span>â†’</span>
          <span class="font-semibold">${LANGS[item.toLang] || item.toLang}</span>
        </div>
        <div class="font-semibold truncate text-white" title="${item.fromText}">${item.fromText}</div>
        <div class="text-blue-300 truncate mt-1" title="${item.toText}">${item.toText}</div>
      `;
      div.onclick = () => {
        src.value = item.fromText;
        tgt.value = item.toText;
        langFrom.value = item.fromLang;
        langTo.value = item.toLang;
        src.focus();
        showToast('Loaded history translation');
      };
      historyList.appendChild(div);
    });
  }
  clearHistoryBtn.onclick = () => { localStorage.removeItem('translationHistory'); renderHistory(); showToast('History cleared'); };

  //==== Setup languages ====
  function fillLangs(){
    for(const [code,label] of Object.entries(LANGS)){
      const o1 = document.createElement('option'); o1.value = code; o1.text = label;
      const o2 = o1.cloneNode(true);
      langFrom.appendChild(o1); langTo.appendChild(o2);
    }
    langFrom.value = 'auto'; langTo.value = 'hi';
  }
  fillLangs();

  //==== Toast ====
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.remove('hidden');
    setTimeout(()=>toast.classList.add('hidden'), 1800);
  }

  //==== Speak & Copy ====
  function speak(text, langCode){
    if(!text) return;
    const u = new SpeechSynthesisUtterance(text);
    if(langCode && langCode!=='auto') u.lang = langCode.split('-')[0];
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
  speakSrc.onclick = () => speak(src.value, langFrom.value);
  speakTgt.onclick = () => speak(tgt.value, langTo.value);
  copySrc.onclick = () => navigator.clipboard.writeText(src.value).then(()=>showToast('Copied'));
  copyTgt.onclick = () => navigator.clipboard.writeText(tgt.value).then(()=>showToast('Copied'));

  swapBtn.onclick = () => {
    [langFrom.value, langTo.value] = [langTo.value, langFrom.value];
    [src.value, tgt.value] = [tgt.value, src.value];
    showToast('Swapped');
    src.focus();
  };

  //==== Translation ====
  async function fetchTimeout(resource, options = {}, timeout = 9000){
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    try {
      const res = await fetch(resource, {...options, signal: controller.signal});
      clearTimeout(id);
      return res;
    } catch(err){ clearTimeout(id); throw err; }
  }
  async function detectLanguage(text){
    try {
      const res = await fetchTimeout('https://libretranslate.de/detect', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({q: text})}, 7000);
      const j = await res.json();
      if(j[0]?.language) return j[0].language;
    } catch{}
    return 'en';
  }
  async function translateText(text, from, to){
    let source = from === 'auto' ? await detectLanguage(text) : from;
    const short = c => c.split('-')[0];
    try {
      const res = await fetchTimeout('https://libretranslate.de/translate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({q: text, source: short(source), target: short(to)})}, 9000);
      const j = await res.json();
      if(j.translatedText) return j.translatedText;
    } catch{}
    // Fallback to MyMemory
    try {
      const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${short(source)}|${short(to)}`;
      const res2 = await fetchTimeout(url, {}, 9000);
      const j2 = await res2.json();
      return j2?.responseData?.translatedText || '';
    } catch{}
    return '';
  }
  translateBtn.onclick = async () => {
    if(!src.value.trim()) return showToast('Enter or OCR some text');
    translateBtn.disabled = true; translateBtn.textContent = 'Translating...';
    try {
      const translation = await translateText(src.value.trim(), langFrom.value, langTo.value);
      tgt.value = translation;
      addHistory(langFrom.value, src.value.trim(), langTo.value, translation);
      showToast('Translated');
    } catch(e){ showToast('Translation failed.'); }
    finally { translateBtn.disabled = false; translateBtn.textContent = 'Translate'; }
  };
  src.addEventListener('input', debounce(() => { tgt.value = ''; }, 300));

  //==== Mic ====
  const supportsSTT = ('SpeechRecognition' in window) || ('webkitSpeechRecognition' in window);
  let recog = null, isListening = false;
  if(supportsSTT){
    const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
    recog = new Rec();
    recog.interimResults = true;
    recog.onresult = e => { src.value = Array.from(e.results).map(r => r[0].transcript).join(''); };
    recog.onend = () => { isListening=false; micBtn.classList.remove('bg-red-500'); micBtn.classList.add('bg-blue-700'); micBtn.innerHTML='<span class="material-icons" style="font-size:22px;vertical-align:middle">mic</span> <span class="ml-2 hide-mobile">Speak</span>'; };
  } else { micBtn.style.display = 'none'; }
  micBtn.onclick = () => {
    if(!supportsSTT) return showToast('No speech recognition support');
    if(isListening){ recog.stop(); isListening=false; micBtn.classList.remove('bg-red-500'); micBtn.classList.add('bg-blue-700'); micBtn.innerHTML='<span class="material-icons" style="font-size:22px;vertical-align:middle">mic</span> <span class="ml-2 hide-mobile">Speak</span>'; return; }
    recog.lang = (langFrom.value === 'auto') ? 'en-US' : langFrom.value.split('-')[0];
    src.value = ''; recog.start(); isListening=true; micBtn.classList.remove('bg-blue-700'); micBtn.classList.add('bg-red-500'); micBtn.innerHTML='<span class="material-icons" style="font-size:22px;vertical-align:middle">mic</span> <span class="ml-2 hide-mobile">Listeningâ€¦</span>';
  };

  //==== Camera / OCR ====
  let stream = null;
  function setOCRState(text, progress=null){
    ocrStatus.textContent = text;
    ocrProgress.classList.toggle('hidden', progress===null);
    if(progress!==null) ocrProgress.value = progress;
  }
  uploadBtn.onclick = () => imgInput.click();
  imgInput.onchange = e => { if(e.target.files[0]) ocrFile(e.target.files[0]); };
  openCamBtn.onclick = async () => {
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject = stream; await video.play();
      mediaWrap.classList.remove('hidden');
      captureBtn.disabled=false; closeCamBtn.disabled=false;
    }
    catch{ showToast('Camera error'); }
  };
  closeCamBtn.onclick = () => {
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; mediaWrap.classList.add('hidden'); captureBtn.disabled=true; closeCamBtn.disabled=true; }
  };
  captureBtn.onclick = () => {
    if(!video.videoWidth) return;
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    canvas.toBlob(b=>ocrFile(b),'image/jpeg',0.9);
  };
  async function ocrFile(fileOrBlob){
    try{
      setOCRState('OCR: loading', 0);
      const preferLang = TESSERACT_LANG[(langFrom.value==='auto'?'en':langFrom.value.split('-')[0])] || 'eng';
      const worker = await Tesseract.createWorker(preferLang, 1, {logger: m => { if(m.status) setOCRState(`OCR: ${m.status}`, m.progress); }});
      const { data: { text } } = await worker.recognize(fileOrBlob);
      await worker.terminate();
      src.value = text.trim();
      setOCRState('OCR: done', null);
      translateBtn.click();
    }catch{ showToast('OCR failed'); setOCRState('OCR: error', null); }
  }

  //==== Dark/Day Mode Toggle ====
  let darkMode = true;
  function setDarkMode(on) {
    darkMode = on;
    document.body.classList.toggle('day-mode', !darkMode);
    document.body.classList.toggle('text-white', darkMode);
    document.body.classList.toggle('text-black', !darkMode);
    darkToggle.textContent = darkMode ? "ðŸŒ™" : "â˜€ï¸";
    showToast(darkMode ? 'Dark mode!' : 'Day mode!');
  }
  darkToggle.onclick = () => setDarkMode(!darkMode);

  //==== Keyboard Navigation ====
  document.body.addEventListener('keydown', e => {
    if (e.key === "Escape") {
      closeCamBtn.click();
      toast.classList.add('hidden');
    }
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") translateBtn.click();
  });

  //==== Load history on start ====
  renderHistory();
  setDarkMode(true);
})();
</script>
</body>
</html>